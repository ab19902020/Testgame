import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc } from 'firebase/firestore';
// IMPORTANT: For Word export to work, add this script to your HTML file's <head>
// <script src="https://unpkg.com/docx@8.2.2/build/index.js"></script>

// --- Firebase Initialization ---
const fallbackFirebaseConfig = {
  apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  authDomain: "your-project-id.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project-id.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:0000000000000000000000"
};

const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : fallbackFirebaseConfig;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

let app;
let auth;
let db;
try {
  app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
} catch (e) {
  console.error("Firebase initialization failed. Saving and loading will be disabled.", e);
}

// --- Constants ---
const GENRES = [
    'Fantasy', 'Epic Fantasy', 'Urban Fantasy',
    'Science Fiction', 'Hard Sci-Fi', 'Space Opera', 'Cyberpunk', 'Steampunk',
    'Horror', 'Psychological Horror', 'Cosmic Horror', 'Gothic',
    'Mystery', 'Cozy Mystery', 'Hardboiled Detective', 'Noir',
    'Thriller', 'Political Thriller', 'Spy Fiction',
    'Romance', 'Contemporary Romance', 'Historical Romance', 'Paranormal Romance', 'Romantic Suspense', 'LGBTQ+ Fiction',
    'Adventure', 'Historical Fiction', 'Western', 'Comedy', 'Literary Fiction',
    "Children's Story", "Toddler's Story"
];
const STYLES = [
    'Stephen King', 'J.R.R. Tolkien', 'Agatha Christie', 'Jane Austen',
    'H.P. Lovecraft', 'Ernest Hemingway', 'William Gibson', 'Neil Gaiman',
    'George Orwell', 'J.K. Rowling', 'Douglas Adams', 'Edgar Allan Poe',
    'Raymond Chandler', 'Philip K. Dick', 'Kurt Vonnegut', 'Seth Rogen',
    'Virginia Woolf', 'James Joyce', 'Gabriel García Márquez',
    'Dr. Seuss', 'Eric Carle', 'Beatrix Potter',
    'Sylvia Day', 'Anne Rice', 'Kylie Scott', 'Helen Hoang', 'Christina Lauren'
];
const AGE_RATINGS = ['All Ages', '13+', '16+', '18+'];
const WORD_COUNTS = ['~1000 words (Short)', '~2500 words (Standard)', '~5000 words (Long)', '~10000 words (Epic)'];
const CHILDRENS_WORD_COUNTS = ['~100 words (Picture Book)', '~250 words', '~500 words', '~750 words'];

// --- API Fetcher ---
const generateContent = async (prompt) => {
    let attempt = 1;
    while (attempt <= 5) {
        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) return result.candidates[0].content.parts[0].text;
            throw new Error("Invalid response from API.");
        } catch (err) {
            if (attempt === 5) throw err;
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
            attempt++;
        }
    }
};

// --- Main App Component ---
const App = () => {
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [isSidebarOpen, setIsSidebarOpen] = useState(false);
    const [activeStoryId, setActiveStoryId] = useState(null);
    const [activeStoryData, setActiveStoryData] = useState(null);
    const [savedStories, setSavedStories] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isGenerating, setIsGenerating] = useState(false);
    const [notification, setNotification] = useState('');
    const [error, setError] = useState(null);
    const [isDownloading, setIsDownloading] = useState(false);

    useEffect(() => {
        if (!auth) {
            setIsAuthReady(true);
            setIsLoading(false);
            setError("Firebase not configured. Saving is disabled.");
            return;
        }
        const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
                setUserId(currentUser.uid);
            } else {
                try {
                    if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch (err) { setError("Authentication failed."); }
            }
            setIsAuthReady(true);
            setIsLoading(false);
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        if (!isAuthReady || !userId || !db) return;
        const storiesPath = `artifacts/${appId}/users/${userId}/stories`;
        const q = query(collection(db, storiesPath));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const stories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            stories.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
            setSavedStories(stories);
        }, () => setError("Could not fetch stories."));
        return () => unsubscribe();
    }, [isAuthReady, userId]);

    const showNotification = (message) => {
        setNotification(message);
        setTimeout(() => setNotification(''), 3000);
    };

    const createNewStory = async (type, prefill = {}) => {
        if (!userId || !db) { setError("Saving is disabled."); return; }
        const base = {
            title: `Untitled ${type === 'short' ? 'Story' : 'Novel'}`,
            genre: GENRES[0], style: STYLES[0], ageRating: AGE_RATINGS[0],
            createdAt: serverTimestamp(), type,
        };
        const newStory = type === 'short'
            ? { ...base, wordCount: WORD_COUNTS[0], content: '', setup: { characters: '', setting: '', plot: '', problem: '', resolution: '', theme: '' }, ...prefill }
            : { ...base, chapters: [], plotSummary: '', characters: '', theme: '', ...prefill };
        try {
            const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/stories`), newStory);
            setActiveStoryId(docRef.id);
            setActiveStoryData({ id: docRef.id, ...newStory });
            setIsSidebarOpen(false);
        } catch (err) { setError("Failed to create story."); }
    };
    
    const loadStory = (id) => {
        const story = savedStories.find(s => s.id === id);
        if (story) { setActiveStoryId(id); setActiveStoryData(story); setIsSidebarOpen(false); }
    };

    const deleteStory = async (id) => {
        if (!userId || !db) { setError("Saving is disabled."); return; }
        try {
            if (activeStoryId === id) { setActiveStoryId(null); setActiveStoryData(null); }
            await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/stories`, id));
            showNotification("Story deleted.");
        } catch (err) { setError("Failed to delete story."); }
    };

    const saveActiveStory = async () => {
        if (!userId || !activeStoryId || !activeStoryData || !db) { setError("Saving is disabled."); return; }
        try {
            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/stories`, activeStoryId), activeStoryData, { merge: true });
            showNotification("Story saved!");
        } catch (err) { setError("Failed to save story."); }
    };

    const handleDownload = async () => {
        if (!activeStoryData || (activeStoryData.type === 'short' && !activeStoryData.content) || (activeStoryData.type === 'novel' && !activeStoryData.chapters?.length)) {
            setError("There is no story content to download."); return;
        }
        if (typeof docx === 'undefined') {
            setError("Docx library not found. Cannot download."); return;
        }
        setIsDownloading(true); setError(null);
        try {
            const { Packer, Document, Paragraph, HeadingLevel } = docx;
            const title = new Paragraph({ text: activeStoryData.title || "Untitled Story", heading: HeadingLevel.TITLE, alignment: 'center' });
            const children = [title];
            if (activeStoryData.type === 'short') {
                activeStoryData.content.split('\n').forEach(p => children.push(new Paragraph({ text: p })));
            } else {
                activeStoryData.chapters.forEach((chapter, index) => {
                    children.push(new Paragraph({ text: `Chapter ${index + 1}`, heading: HeadingLevel.HEADING_2, spacing: { before: 400, after: 200 } }));
                    chapter.split('\n').forEach(p => children.push(new Paragraph({ text: p })));
                });
            }
            const doc = new Document({ sections: [{ children }] });
            const blob = await Packer.toBlob(doc);
            const sanitizedTitle = (activeStoryData.title || 'story').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${sanitizedTitle}.docx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        } catch (err) { setError("Failed to create Word document."); }
        finally { setIsDownloading(false); }
    };

    if (isLoading) return <div className="bg-slate-900 text-white min-h-screen flex items-center justify-center text-xl">Initializing...</div>;

    return (
        <div className="bg-slate-900 bg-grid-slate-700/[0.05] text-white h-screen w-screen font-sans overflow-hidden">
            {notification && <div className="fixed top-5 right-5 bg-emerald-500 text-white py-2 px-4 rounded-lg shadow-lg z-50">{notification}</div>}
            <div className="relative h-full lg:flex">
                <StorySidebar {...{ stories: savedStories, activeId: activeStoryId, onNewStory: createNewStory, onLoadStory: loadStory, onDeleteStory: deleteStory, isOpen: isSidebarOpen, setIsOpen: setIsSidebarOpen, setError }} />
                <main className="w-full lg:ml-[25rem] h-full flex flex-col">
                    <header className="p-4 sm:p-6 lg:hidden flex-shrink-0 z-10">
                         <button onClick={() => setIsSidebarOpen(true)} className="p-2 bg-slate-800 rounded-md self-start">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
                         </button>
                    </header>
                    <div className="flex-grow px-4 sm:px-6 pb-4 min-h-0">
                        <div className="bg-slate-800 rounded-lg h-full flex flex-col">
                            {!activeStoryData ? 
                                <WelcomeScreen /> : 
                                activeStoryData.type === 'short' ?
                                    <ShortStoryGenerator {...{ story: activeStoryData, setStory: setActiveStoryData, onSave: saveActiveStory, isGenerating, setIsGenerating, setError, onDownload: handleDownload, isDownloading }} /> :
                                    <NovelWriter {...{ story: activeStoryData, setStory: setActiveStoryData, onSave: saveActiveStory, isGenerating, setIsGenerating, setError, onDownload: handleDownload, isDownloading }} />
                            }
                        </div>
                    </div>
                    {error && <p className="text-red-400 text-center fixed bottom-5 left-1/2 -translate-x-1/2 bg-slate-900 p-3 rounded-lg shadow-lg">{error}</p>}
                </main>
            </div>
        </div>
    );
};

// --- Child Components ---
const SelectDropdown = ({ label, value, onChange, options }) => (
    <div>
        <label className="block text-sm font-semibold text-slate-400 mb-1">{label}</label>
        <select value={value} onChange={e => onChange(e.target.value)} className="w-full bg-slate-700/50 text-white rounded-lg p-2.5 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            {options.map(o => <option key={o} value={o}>{o}</option>)}
        </select>
    </div>
);

const StorySidebar = ({ stories, activeId, onNewStory, onLoadStory, onDeleteStory, isOpen, setIsOpen, setError }) => {
    const surpriseMe = async () => {
        setError(null);
        try {
            const prompt = "Generate a single, quirky, and imaginative opening line for a story. Just the line, nothing else.";
            const openingLine = await generateContent(prompt);
            const randomGenre = GENRES[Math.floor(Math.random() * GENRES.length)];
            const randomStyle = STYLES[Math.floor(Math.random() * STYLES.length)];
            onNewStory('short', {
                genre: randomGenre,
                style: randomStyle,
                setup: {
                    plot: openingLine.replace(/"/g, ''),
                    characters: '', setting: '', problem: '', resolution: '', theme: ''
                }
            });
        } catch (e) {
            setError("Could not generate a surprise. Please try again.");
        }
    };

    return (
        <>
            <div onClick={() => setIsOpen(false)} className={`fixed inset-0 bg-black/60 z-30 lg:hidden transition-opacity ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}></div>
            <aside className={`fixed top-0 left-0 h-full w-full max-w-sm bg-slate-800/95 backdrop-blur-sm border-r border-slate-700 p-4 flex flex-col z-40 transform transition-transform lg:translate-x-0 lg:w-[25rem] ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                 <div className="flex justify-between items-center mb-6">
                    <h2 className="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Story Weaver</h2>
                    <button onClick={() => setIsOpen(false)} className="lg:hidden p-2 text-slate-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m12 13.4l-4.9 4.9q-.275.275-.7.275t-.7-.275q-.275-.275-.275-.7t.275-.7l4.9-4.9l-4.9-4.9q-.275-.275-.275-.7t.275-.7q.275-.275.7-.275t.7.275l4.9 4.9l4.9-4.9q.275-.275.7-.275t.7.275q.275.275.275.7t-.275.7L13.4 12l4.9 4.9q.275.275.275.7t-.275.7q-.275.275-.7.275t-.7-.275L12 13.4Z"/></svg></button>
                </div>
                <div className="grid grid-cols-2 gap-3 mb-2">
                    <button onClick={() => onNewStory('short')} className="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 px-3 rounded-lg transition-colors text-sm shadow-lg shadow-indigo-600/20">New Short</button>
                    <button onClick={() => onNewStory('novel')} className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-3 rounded-lg transition-colors text-sm shadow-lg shadow-purple-600/20">New Novel</button>
                </div>
                 <button onClick={surpriseMe} className="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold py-2.5 px-3 rounded-lg transition-colors text-sm shadow-lg shadow-amber-500/20 mb-4">Surprise Me!</button>
                <div className="overflow-y-auto flex-grow -mr-2 pr-2">
                    {stories.map(story => (
                        <div key={story.id} onClick={() => onLoadStory(story.id)} className={`relative group p-3 rounded-lg cursor-pointer mb-2 ${activeId === story.id ? 'bg-indigo-500/30' : 'bg-slate-700/40 hover:bg-slate-700/80'}`}>
                            <h3 className="font-bold truncate text-slate-200">{story.title}</h3>
                            <p className="text-xs text-slate-400">{story.type === 'short' ? 'Short Story' : 'Novel'} - {story.genre}</p>
                            <button onClick={(e) => { e.stopPropagation(); onDeleteStory(story.id); }} className="absolute top-1/2 -translate-y-1/2 right-2 p-1 rounded-full text-slate-400 hover:bg-red-500 hover:text-white opacity-0 group-hover:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                        </div>
                    ))}
                </div>
            </aside>
        </>
    );
};

const WelcomeScreen = () => (
    <div className="flex-grow flex flex-col items-center justify-center text-center h-full p-4">
        <h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Welcome to AI Story Weaver</h1>
        <p className="text-slate-400 text-lg sm:text-xl mt-4">Select a story from the menu or create a new one to begin.</p>
    </div>
);

const ShortStoryGenerator = ({ story, setStory, onSave, isGenerating, setIsGenerating, setError, onDownload, isDownloading }) => {
    const handleSetupChange = (field, value) => setStory(prev => ({ ...prev, setup: { ...prev.setup, [field]: value } }));
    const handleMainChange = (field, value) => setStory(prev => ({ ...prev, [field]: value }));
    const handleContentChange = (value) => setStory(prev => ({ ...prev, content: value }));
    const isChildrensGenre = story.genre === "Children's Story" || story.genre === "Toddler's Story";
    const wordCountOptions = isChildrensGenre ? CHILDRENS_WORD_COUNTS : WORD_COUNTS;

    useEffect(() => {
        if (!wordCountOptions.includes(story.wordCount)) {
            handleMainChange('wordCount', wordCountOptions[0]);
        }
    }, [story.genre]);


    const generateShortStory = async () => {
        setIsGenerating(true); setError(null);
        const prompt = `
            You are a master storyteller. Your task is to write a complete short story in the exact style of ${story.style}.
            The story must be cohesive, deeply engaging, and approximately ${story.wordCount} long.
            Adhere strictly to the ${story.ageRating} guidelines. The writing must be of world-class, publishable quality.
            STORY DETAILS:
            - Genre: ${story.genre}
            - Theme or Moral: ${story.setup.theme || 'Not specified.'}
            - Characters: ${story.setup.characters || 'As you see fit.'}
            - Setting: ${story.setup.setting || 'As you see fit.'}
            - Plot: ${story.setup.plot || 'A compelling plot you devise.'}
            - Problem/Threat: ${story.setup.problem || 'A central conflict you devise.'}
            - Resolution: ${story.setup.resolution || 'A fitting end you devise.'}
        `;
        try {
            const result = await generateContent(prompt);
            handleContentChange(result);
            await onSave();
        } catch (err) { setError(err.message); }
        finally { setIsGenerating(false); }
    };

    return (
        <div className="p-4 sm:p-6 h-full flex flex-col overflow-y-auto">
            <div className="flex-shrink-0">
                <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <input type="text" value={story.title} onChange={e => handleMainChange('title', e.target.value)} className="text-3xl sm:text-4xl font-bold bg-transparent border-b-2 border-slate-700 focus:border-indigo-500 outline-none w-full sm:w-2/3 p-1"/>
                     <div className="flex gap-2 w-full sm:w-auto flex-shrink-0">
                        <button onClick={onDownload} disabled={isDownloading || !story.content} className="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg w-full shadow-lg shadow-sky-600/20 disabled:opacity-50">
                            {isDownloading ? '...' : 'Word'}
                        </button>
                        <button onClick={onSave} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg w-full shadow-lg shadow-emerald-600/20">Save</button>
                     </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <SelectDropdown label="Genre" value={story.genre} onChange={(v) => handleMainChange('genre', v)} options={GENRES} />
                    <SelectDropdown label="Style" value={story.style} onChange={(v) => handleMainChange('style', v)} options={STYLES} />
                    <SelectDropdown label="Age Rating" value={story.ageRating} onChange={(v) => handleMainChange('ageRating', v)} options={AGE_RATINGS} />
                    <SelectDropdown label="Word Count" value={story.wordCount} onChange={(v) => handleMainChange('wordCount', v)} options={wordCountOptions} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <textarea placeholder="Characters" value={story.setup.characters} onChange={e => handleSetupChange('characters', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg border border-slate-700" rows="2"></textarea>
                    <textarea placeholder="Setting" value={story.setup.setting} onChange={e => handleSetupChange('setting', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg border border-slate-700" rows="2"></textarea>
                    <textarea placeholder="Plot" value={story.setup.plot} onChange={e => handleSetupChange('plot', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg border border-slate-700" rows="2"></textarea>
                    <textarea placeholder="Problem/Threat" value={story.setup.problem} onChange={e => handleSetupChange('problem', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg border border-slate-700" rows="2"></textarea>
                    <div className="col-span-1 sm:col-span-2">
                        <textarea placeholder="Resolution" value={story.setup.resolution} onChange={e => handleSetupChange('resolution', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg w-full border border-slate-700" rows="2"></textarea>
                    </div>
                     <div className="col-span-1 sm:col-span-2">
                        <textarea placeholder="Theme or Moral (Optional)" value={story.setup.theme} onChange={e => handleSetupChange('theme', e.target.value)} className="bg-slate-700/50 p-2 rounded-lg w-full border border-slate-700" rows="1"></textarea>
                    </div>
                </div>
                <button onClick={generateShortStory} disabled={isGenerating} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 font-bold py-3 px-6 rounded-lg disabled:opacity-50 mb-4 shadow-lg shadow-indigo-600/30">
                    {isGenerating ? 'Generating...' : 'Generate Short Story'}
                </button>
            </div>
            <div className="flex-grow bg-slate-900/70 rounded-lg p-4 border border-slate-700 min-h-[200px]">
                <textarea value={story.content} onChange={e => handleContentChange(e.target.value)} className="w-full h-full bg-transparent text-slate-300 resize-none outline-none leading-relaxed"></textarea>
            </div>
        </div>
    );
};

const NovelWriter = ({ story, setStory, onSave, isGenerating, setIsGenerating, setError, onDownload, isDownloading }) => {
    const [nextChapterPrompt, setNextChapterPrompt] = useState('');
    const handleSetupChange = (field, value) => setStory(prev => ({ ...prev, [field]: value }));
    const contentRef = useRef(null);

    useEffect(() => {
        if (contentRef.current) contentRef.current.scrollTop = contentRef.current.scrollHeight;
    }, [story.chapters]);

    const generateNextChapter = async () => {
        setIsGenerating(true); setError(null);
        const chapterNumber = (story.chapters?.length || 0) + 1;
        const previousChaptersSummary = story.chapters?.map((c, i) => `Chapter ${i+1} Summary: ${c.substring(0, 150)}...`).join('\n');
        const prompt = `
            You are a master novelist. Your task is to continue this novel by writing the next chapter. 
            It is crucial that you maintain perfect consistency with the established plot, character voices, tone, and the overarching style of ${story.style}.
            
            NOVEL SYNOPSIS:
            - Title: ${story.title}
            - Genre: ${story.genre}
            - Theme or Moral: ${story.theme || 'Not specified.'}
            - Main Plot: ${story.plotSummary}
            - Key Characters: ${story.characters}
            
            SUMMARY OF PREVIOUS CHAPTERS:
            ${previousChaptersSummary || "This is the first chapter."}
            
            USER'S PROMPT FOR THIS CHAPTER:
            ${nextChapterPrompt || "Continue the story naturally."}

            INSTRUCTIONS:
            Write Chapter ${chapterNumber}. Use the user's prompt to guide the events of this chapter. If no prompt is given, continue the story in a logical and compelling way. Do not add a title like "Chapter X". The prose must be seamless with the preceding text and of world-class quality.
        `;
        try {
            const result = await generateContent(prompt);
            const updatedChapters = [...(story.chapters || []), result];
            setStory(prev => ({...prev, chapters: updatedChapters}));
            setNextChapterPrompt('');
            await onSave();
        } catch (err) { setError(err.message); }
        finally { setIsGenerating(false); }
    };

    return (
        <div className="p-4 sm:p-6 h-full flex flex-col overflow-y-auto">
            <div className="flex-shrink-0">
                <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                     <input type="text" value={story.title} onChange={e => handleSetupChange('title', e.target.value)} className="text-3xl sm:text-4xl font-bold bg-transparent border-b-2 border-slate-700 focus:border-indigo-500 outline-none w-full sm:w-2/3 p-1"/>
                     <div className="flex gap-2 w-full sm:w-auto flex-shrink-0">
                        <button onClick={onDownload} disabled={isDownloading || !story.chapters?.length} className="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg w-full shadow-lg shadow-sky-600/20 disabled:opacity-50">
                            {isDownloading ? '...' : 'Word'}
                        </button>
                        <button onClick={onSave} className="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg w-full shadow-lg shadow-emerald-600/20">Save</button>
                     </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                    <SelectDropdown label="Genre" value={story.genre} onChange={(v) => handleSetupChange('genre', v)} options={GENRES} />
                    <SelectDropdown label="Style" value={story.style} onChange={(v) => handleSetupChange('style', v)} options={STYLES} />
                    <SelectDropdown label="Age Rating" value={story.ageRating} onChange={(v) => handleSetupChange('ageRating', v)} options={AGE_RATINGS} />
                </div>
                <textarea placeholder="Plot Summary" value={story.plotSummary} onChange={e => handleSetupChange('plotSummary', e.target.value)} rows="2" className="bg-slate-700/50 p-2 rounded-lg w-full mb-2 border border-slate-700"></textarea>
                <textarea placeholder="Key Characters" value={story.characters} onChange={e => handleSetupChange('characters', e.target.value)} rows="2" className="bg-slate-700/50 p-2 rounded-lg w-full mb-2 border border-slate-700"></textarea>
                <textarea placeholder="Theme or Moral (Optional)" value={story.theme} onChange={e => handleSetupChange('theme', e.target.value)} rows="1" className="bg-slate-700/50 p-2 rounded-lg w-full mb-4 border border-slate-700"></textarea>
            </div>
            <div ref={contentRef} className="flex-grow bg-slate-900/70 rounded-lg p-4 overflow-y-auto mb-4 border border-slate-700 min-h-[200px]">
                {story.chapters?.map((chapter, index) => (
                    <div key={index} className="mb-6">
                        <h4 className="text-2xl font-bold text-indigo-400 mb-2">Chapter {index + 1}</h4>
                        <p className="text-slate-300 whitespace-pre-wrap leading-relaxed">{chapter}</p>
                    </div>
                ))}
                {isGenerating && <div className="text-center p-4 text-slate-400">Generating...</div>}
            </div>
            <div className="flex-shrink-0">
                <div className="mb-4">
                    <label htmlFor="nextChapterPrompt" className="block text-sm font-semibold text-slate-400 mb-1">
                        Ideas or Prompts for the Next Chapter
                    </label>
                    <textarea
                        id="nextChapterPrompt"
                        value={nextChapterPrompt}
                        onChange={e => setNextChapterPrompt(e.target.value)}
                        placeholder="e.g., The detective finds a mysterious clue. A new character is introduced..."
                        rows="3"
                        className="bg-slate-700/50 p-2 rounded-lg w-full border border-slate-700"
                    ></textarea>
                </div>
                <button onClick={generateNextChapter} disabled={isGenerating} className="w-full bg-gradient-to-r from-purple-600 to-fuchsia-600 font-bold py-3 px-6 rounded-lg disabled:opacity-50 shadow-lg shadow-purple-600/30">
                    {isGenerating ? 'Weaving...' : `Generate Chapter ${story.chapters?.length + 1 || 1}`}
                </button>
            </div>
        </div>
    );
};

export default App;


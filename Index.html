
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Head Rush</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Paytone+One&display=swap" rel="stylesheet">
    <style>
        body, .btn {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, #card-word, .category-btn-text, #results-screen h2, #review-modal h2, .category-group-title, .modal h2 {
            font-family: 'Paytone One', sans-serif;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        /* --- Themes --- */
        .theme-dark {
            --bg-color: #111827; --text-color: #f9fafb; --text-muted-color: #9ca3af;
            --card-bg-color: #1f2937; --card-text-color: #f9fafb; --card-category-color: #a5b4fc;
            --btn-secondary-bg: rgba(255, 255, 255, 0.1);
        }
        .theme-light {
            --bg-color: #f3f4f6; --text-color: #1f2937; --text-muted-color: #4b5563;
            --card-bg-color: #ffffff; --card-text-color: #1f2937; --card-category-color: #4f46e5;
            --btn-secondary-bg: rgba(0, 0, 0, 0.1);
        }
        body { background-color: var(--bg-color); color: var(--text-color); }
        .category-btn, #back-to-start-btn, #change-category-btn { background-color: var(--btn-secondary-bg); color: var(--text-color); }
        .category-btn.selected { border: 4px solid #4f46e5; transform: scale(1.05); }
        
        #card-face { background-color: var(--card-bg-color); }
        #card-word { color: var(--card-text-color); }
        #card-category { color: var(--card-category-color); font-weight: 700; }
        
        .card { transform-style: preserve-3d; transition: transform 0.7s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .card.flipped { transform: rotateY(180deg) scale(1.05); }
        .card-face, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; }
        .card-back { transform: rotateY(180deg); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.25); }
        .btn:active { transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .primary-btn {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6);
        }
        
        #confetti-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 9999; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; opacity: 0; animation: fall 4s ease-in forwards; }
        @keyframes fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }

        #camera-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 100px; height: 100px; border-radius: 50%;
            overflow: hidden; border: 3px solid white; z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        #camera-view { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        #start-game-btn {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        .screen, .modal { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (orientation: landscape) {
            #game-screen-layout { flex-direction: row; align-items: center; gap: 5vw; padding: 1rem 2rem; }
            #card-area { order: 2; width: 50vw; height: 50vh; max-width: 500px; flex-shrink: 0; }
            #game-controls { order: 1; flex-direction: column; justify-content: center; gap: 1rem; width: auto; margin-top: 0; }
            #timer { margin-bottom: 1rem; }
            #camera-container { top: 1rem; left: 1rem; transform: none; }
            #end-round-btn { top: 1rem; right: 1rem; left: auto; transform: none; }
        }
    </style>
</head>
<body class="theme-dark min-h-screen flex items-center justify-center p-4">

    <canvas id="recording-canvas" class="hidden"></canvas>
    <div id="confetti-container"></div>
    <div id="app" class="w-full max-w-md mx-auto text-center flex flex-col h-screen">

        <!-- Start Screen -->
        <div id="start-screen" class="screen flex-grow flex flex-col justify-center items-center space-y-4 px-4">
            <h1 class="text-8xl font-bold tracking-tight drop-shadow-lg mb-2">Head Rush</h1>
            <p class="text-xl mb-4 text-gray-400">The hilarious guessing game.</p>
            <button id="start-game-btn" class="w-full primary-btn text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg btn mb-4 flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                Play
            </button>
            <div class="flex space-x-4 mb-4">
                <button id="how-to-play-btn" class="w-full font-bold py-3 px-6 rounded-full btn" style="background-color: var(--btn-secondary-bg);">How to Play</button>
                <button id="rules-btn" class="w-full font-bold py-3 px-6 rounded-full btn" style="background-color: var(--btn-secondary-bg);">Rules</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between space-x-4 p-3 rounded-full w-72" style="background-color: var(--btn-secondary-bg);">
                    <label for="record-toggle" class="font-medium text-lg">Record Performance</label>
                    <button id="record-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-400 flex-shrink-0">
                        <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                    </button>
                </div>
                <div class="flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <button id="theme-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-400">
                        <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                    </button>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </div>
            </div>
        </div>

        <!-- Category Screen -->
        <div id="category-screen" class="hidden screen flex-grow flex flex-col">
            <h2 class="text-5xl font-bold mt-8 mb-4 drop-shadow-md">Choose Decks</h2>
            <div id="category-list" class="flex-grow overflow-y-auto p-2 space-y-6"></div>
            <div class="py-4 space-y-2 px-2">
                 <button id="start-selected-btn" class="w-full primary-btn text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg btn opacity-50 cursor-not-allowed" disabled>Start Game</button>
                 <button id="back-to-start-btn" class="w-full font-bold py-3 px-6 rounded-full btn">Back</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden screen">
            <div id="game-screen-layout" class="fixed inset-0 bg-black/80 flex flex-col items-center justify-center p-4">
                 <div id="camera-container" class="hidden">
                    <video id="camera-view" autoplay playsinline muted></video>
                 </div>
                 <button id="end-round-btn" class="absolute top-4 right-4 bg-white/20 text-white font-bold py-2 px-4 rounded-full btn z-10">End Round</button>
                 <div id="card-area" class="relative w-full h-64" style="perspective: 1000px;">
                    <div id="card" class="card w-full h-full">
                        <div id="card-face" class="card-face flex items-center justify-center rounded-2xl shadow-2xl p-4">
                            <div class="text-center relative z-10 p-2">
                                <p id="card-category" class="text-xl font-bold mb-2"></p>
                                <p id="card-word" class="font-bold"></p>
                            </div>
                        </div>
                         <div class="card-back flex items-center justify-center bg-indigo-500 rounded-2xl shadow-2xl p-4">
                            <p class="text-white text-3xl font-bold">Next Card</p>
                        </div>
                    </div>
                 </div>
                 <div id="game-controls" class="flex justify-around items-center w-full mt-12">
                     <div id="timer" class="text-5xl font-bold text-white">60</div>
                     <button id="pass-btn" class="bg-red-500 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg btn flex items-center justify-center gap-2">
                        <span class="font-bold text-3xl">✗</span> Pass
                     </button>
                     <button id="correct-btn" class="bg-green-500 text-white font-bold py-4 px-8 rounded-full text-xl shadow-lg btn flex items-center justify-center gap-2">
                        <span class="font-bold text-3xl">✓</span> Correct
                     </button>
                 </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden screen flex-grow flex flex-col justify-center items-center space-y-6">
            <h2 class="text-6xl font-bold">Time's Up!</h2>
            <div class="bg-white/20 p-8 rounded-2xl">
                <p class="text-2xl">You scored</p>
                <p id="score" class="text-8xl font-bold my-4">0</p>
                <p class="text-2xl">correct answers!</p>
            </div>
            <div class="space-y-4 w-full">
                <button id="play-again-btn" class="w-full primary-btn text-white font-bold py-4 px-8 rounded-full text-2xl shadow-lg btn">Play Again</button>
                <button id="change-category-btn" class="w-full font-bold py-3 px-6 rounded-full btn">Change Category</button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loading" class="hidden">
            <div class="fixed inset-0 bg-gray-900/50 flex flex-col items-center justify-center z-50">
                <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-white"></div>
                <p id="loading-status" class="text-white text-xl mt-4"></p>
            </div>
        </div>

        <!-- Video Review Modal -->
        <div id="review-modal" class="hidden screen fixed inset-0 bg-black/80 flex-col items-center justify-center p-4 z-50">
            <h2 class="text-4xl font-bold text-white mb-4">Review Your Performance!</h2>
            <video id="review-video" class="w-full max-w-md rounded-lg mb-4" controls></video>
            <div class="flex space-x-4">
                <button id="discard-btn" class="bg-red-500 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg btn">Discard</button>
                <button id="keep-btn" class="bg-green-500 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg btn">Keep</button>
            </div>
        </div>
        
        <!-- How to Play Modal -->
        <div id="how-to-play-modal" class="hidden modal fixed inset-0 bg-black/80 flex-col items-center justify-center p-4 z-50">
            <div class="p-8 rounded-2xl w-full max-w-md relative" style="background-color: var(--bg-color);">
                <button id="close-how-to-play-btn" class="absolute top-4 right-4 text-3xl">&times;</button>
                <h2 class="text-4xl font-bold mb-4">How to Play</h2>
                <ul class="text-lg text-left space-y-4">
                    <li><span class="font-bold">1.</span> Choose your favorite decks from the list.</li>
                    <li><span class="font-bold">2.</span> Hold your phone to your forehead, screen facing out.</li>
                    <li><span class="font-bold">3.</span> Your friends will shout clues to help you guess the word on the screen.</li>
                    <li><span class="font-bold">4.</span> Tilt your phone <span class="text-green-400 font-bold">DOWN</span> for a correct answer.</li>
                    <li><span class="font-bold">5.</span> Tilt your phone <span class="text-red-400 font-bold">UP</span> to pass and get a new word.</li>
                    <li><span class="font-bold">6.</span> Score as many as you can before the timer runs out!</li>
                </ul>
            </div>
        </div>

        <!-- Rules Modal -->
        <div id="rules-modal" class="hidden modal fixed inset-0 bg-black/80 flex-col items-center justify-center p-4 z-50">
            <div class="p-8 rounded-2xl w-full max-w-md relative" style="background-color: var(--bg-color);">
                <button id="close-rules-btn" class="absolute top-4 right-4 text-3xl">&times;</button>
                <h2 class="text-4xl font-bold mb-4">The Rules</h2>
                <ul class="text-lg text-left space-y-4">
                    <li><span class="font-bold text-green-400 text-2xl">✓</span> Your friends can say anything they want...</li>
                    <li><span class="font-bold text-red-400 text-2xl">✗</span> ...but they CAN'T say the word on the card!</li>
                    <li><span class="font-bold text-red-400 text-2xl">✗</span> No rhyming with the word on the card.</li>
                    <li><span class="font-bold text-green-400 text-2xl">✓</span> Most importantly, have fun!</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- API KEYS ---
            const pexelsApiKey = "O0VwpCi5mGmVm5MsZsUl7fIrs9YerSFplAyquICzlWW0ZcR9iTHeqpUt";
            const tmdbApiKey = "3ea9e43d0b879725ac8fda707021e858";

            // --- DOM Elements ---
            const body = document.body;
            const startScreen = document.getElementById('start-screen');
            const categoryScreen = document.getElementById('category-screen');
            const gameScreen = document.getElementById('game-screen');
            const resultsScreen = document.getElementById('results-screen');
            const loadingIndicator = document.getElementById('loading');
            const loadingStatus = document.getElementById('loading-status');
            const startGameBtn = document.getElementById('start-game-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');
            const categoryList = document.getElementById('category-list');
            const startSelectedBtn = document.getElementById('start-selected-btn');
            const timerDisplay = document.getElementById('timer');
            const cardWord = document.getElementById('card-word');
            const cardCategory = document.getElementById('card-category');
            const cardFace = document.getElementById('card-face');
            const card = document.getElementById('card');
            const passBtn = document.getElementById('pass-btn');
            const correctBtn = document.getElementById('correct-btn');
            const scoreDisplay = document.getElementById('score');
            const playAgainBtn = document.getElementById('play-again-btn');
            const changeCategoryBtn = document.getElementById('change-category-btn');
            const confettiContainer = document.getElementById('confetti-container');
            const themeToggle = document.getElementById('theme-toggle');
            const recordToggle = document.getElementById('record-toggle');
            const cameraContainer = document.getElementById('camera-container');
            const cameraView = document.getElementById('camera-view');
            const reviewModal = document.getElementById('review-modal');
            const reviewVideo = document.getElementById('review-video');
            const discardBtn = document.getElementById('discard-btn');
            const keepBtn = document.getElementById('keep-btn');
            const endRoundBtn = document.getElementById('end-round-btn');
            const recordingCanvas = document.getElementById('recording-canvas');
            const howToPlayBtn = document.getElementById('how-to-play-btn');
            const rulesBtn = document.getElementById('rules-btn');
            const howToPlayModal = document.getElementById('how-to-play-modal');
            const rulesModal = document.getElementById('rules-modal');
            const closeHowToPlayBtn = document.getElementById('close-how-to-play-btn');
            const closeRulesBtn = document.getElementById('close-rules-btn');

            // --- Sound, Media & Animation ---
            let soundsReady = false;
            let correctSound, passSound, tickSound, endSound;
            let mediaRecorder;
            let recordedChunks = [];
            let recordedBlobUrl = null;
            let recordPerformance = false;
            let cameraStream = null;
            let animationFrameId = null;

            // --- Game State ---
            let timer;
            let timeLeft = 60;
            let score = 0;
            let words = [];
            let currentWordIndex = 0;
            let currentCardData = { word: '', category: '' };
            let selectedCategories = [];

            // --- Game Data ---
            const groupedCategories = {
                "Pop Culture": ['Celebrities', 'TV Shows', 'Blockbuster Movies', 'Reality TV', 'TikTok Trends', 'Movie Quotes'],
                "For The Fans": ['The Simpsons', 'Harry Potter', 'Marvel Cinematic Universe', 'Star Wars', 'Gaming Legends', 'Superheroes', 'Fictional Characters', 'Disney Movies', 'Friends (TV Show)'],
                "Music Lovers": ['90s Hits', 'Classic Rock', 'Pop Stars', 'Songs', 'Musicians', 'Country Hits'],
                "Party Starters": ['Act It Out', 'Big Groups', 'Adults Only', 'For Kids', 'Famous Duos', 'Brand Slogans'],
                "Hobbies & Knowledge": ['Animals', 'Food', 'Science', 'History', 'Sports', 'Video Games', 'Car Brands', 'Kitchen Gadgets', 'Objects', 'Famous Landmarks', 'Mythical Creatures'],
                "Just for Fun": ['Accents & Impressions', 'Sounds & Noises', 'Pantomime', 'Board Games', 'Famous Brands']
            };
            
            const categoryImageMap = {
                'Animals': 'https://images.pexels.com/photos/1059823/pexels-photo-1059823.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Celebrities': 'https://images.pexels.com/photos/3777931/pexels-photo-3777931.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Blockbuster Movies': 'https://images.pexels.com/photos/7991579/pexels-photo-7991579.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Sports': 'https://images.pexels.com/photos/1618269/pexels-photo-1618269.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Food': 'https://images.pexels.com/photos/376464/pexels-photo-376464.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'History': 'https://images.pexels.com/photos/111131/parchment-text-paper-old-111131.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Science': 'https://images.pexels.com/photos/2280571/pexels-photo-2280571.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'The Simpsons': 'https://images.pexels.com/photos/163077/donuts-donuts-shop-eat-sweet-163077.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Premier League Football': 'https://images.pexels.com/photos/114296/pexels-photo-114296.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Harry Potter': 'https://images.pexels.com/photos/1344437/pexels-photo-1344437.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Marvel Cinematic Universe': 'https://images.pexels.com/photos/167092/pexels-photo-167092.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Disney Movies': 'https://images.pexels.com/photos/159519/castle-Neuschwanstein-castles-bavaria-159519.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Fast Food Chains': 'https://images.pexels.com/photos/1633578/pexels-photo-1633578.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Video Games': 'https://images.pexels.com/photos/442576/pexels-photo-442576.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'TV Shows': 'https://images.pexels.com/photos/1763075/pexels-photo-1763075.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                '90s Hits': 'https://images.pexels.com/photos/1587927/pexels-photo-1587927.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Classic Rock': 'https://images.pexels.com/photos/1916824/pexels-photo-1916824.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Pop Stars': 'https://images.pexels.com/photos/1105666/pexels-photo-1105666.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Act It Out': 'https://images.pexels.com/photos/33406/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Big Groups': 'https://images.pexels.com/photos/764681/pexels-photo-764681.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Adults Only': 'https://images.pexels.com/photos/3060643/pexels-photo-3060643.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Star Wars': 'https://images.pexels.com/photos/4019766/pexels-photo-4019766.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Friends (TV Show)': 'https://images.pexels.com/photos/1389429/pexels-photo-1389429.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Gaming Legends': 'https://images.pexels.com/photos/3165335/pexels-photo-3165335.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Brand Slogans': 'https://images.pexels.com/photos/264636/pexels-photo-264636.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Kitchen Gadgets': 'https://images.pexels.com/photos/35607/amazing-apple-baking-beautiful.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Country Hits': 'https://images.pexels.com/photos/1587947/pexels-photo-1587947.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Movie Quotes': 'https://images.pexels.com/photos/390089/pexels-photo-390089.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Actors': 'https://images.pexels.com/photos/220453/pexels-photo-220453.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Reality TV': 'https://images.pexels.com/photos/7234313/pexels-photo-7234313.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'TikTok Trends': 'https://images.pexels.com/photos/7189353/pexels-photo-7189353.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Mythical Creatures': 'https://images.pexels.com/photos/162203/pan-god-figure-mythology-162203.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Board Games': 'https://images.pexels.com/photos/789152/pexels-photo-789152.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Famous Inventions': 'https://images.pexels.com/photos/1616470/pexels-photo-1616470.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Accents & Impressions': 'https://images.pexels.com/photos/5490276/pexels-photo-5490276.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Sounds & Noises': 'https://images.pexels.com/photos/3394658/pexels-photo-3394658.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1',
                'Pantomime': 'https://images.pexels.com/photos/209948/pexels-photo-209948.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1'
            };

            // --- Image Fetching ---
            const imageCache = new Map();

            async function fetchTmdbImage(query, category) {
                if (!tmdbApiKey) return null;
                const entertainmentCategories = ['Blockbuster Movies', 'Disney Movies', 'Marvel Cinematic Universe', 'TV Shows', 'The Simpsons', 'Harry Potter', 'Celebrities', 'Musicians', 'Pop Stars', 'Artists', 'Fictional Characters', 'Superheroes', 'Famous Duos', 'Actors', 'Movie Quotes', 'Friends (TV Show)', 'Star Wars'];
                if (!entertainmentCategories.includes(category)) return null;

                let searchType = 'multi';
                if (['Blockbuster Movies', 'Disney Movies', 'Marvel Cinematic Universe', 'Harry Potter', 'Movie Quotes', 'Star Wars'].includes(category)) searchType = 'movie';
                else if (['TV Shows', 'The Simpsons', 'Friends (TV Show)'].includes(category)) searchType = 'tv';
                else if (['Celebrities', 'Musicians', 'Pop Stars', 'Artists', 'Actors'].includes(category)) searchType = 'person';

                const cacheKey = `tmdb-${query}`;
                if (imageCache.has(cacheKey)) return imageCache.get(cacheKey);
                
                try {
                    const response = await fetch(`https://api.themoviedb.org/3/search/${searchType}?api_key=${tmdbApiKey}&query=${encodeURIComponent(query)}`);
                    if (!response.ok) return null;
                    const data = await response.json();
                    const result = data.results[0];
                    if (!result) return null;

                    const imageUrl = result.poster_path || result.profile_path ? `https://image.tmdb.org/t/p/w500${result.poster_path || result.profile_path}` : null;
                    if (imageUrl) imageCache.set(cacheKey, imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error("TMDB API Error:", error);
                    return null;
                }
            }

            async function fetchPexelsImage(query, category) {
                if (!pexelsApiKey) return null;
                
                let refinedQuery = query;
                if (category === 'Famous Brands' || category === 'Fast Food Chains' || category === 'Brand Slogans') refinedQuery = `${query} logo`;
                else if (category === 'Dinosaurs') refinedQuery = `${query} dinosaur`;
                else if (category === 'Famous Landmarks') refinedQuery = `${query} landmark`;
                else if (category === 'Sports') refinedQuery = `${query} sport`;
                else if (category === 'Premier League Football') refinedQuery = `${query} football player`;
                else if (category === 'Video Games' || category === 'Gaming Legends') refinedQuery = `${query} video game`;
                
                const cacheKey = `pexels-${refinedQuery}`;
                if (imageCache.has(cacheKey)) return imageCache.get(cacheKey);

                try {
                    const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(refinedQuery)}&per_page=1`, {
                        headers: { Authorization: pexelsApiKey }
                    });
                    if (!response.ok) return null;
                    const data = await response.json();
                    const imageUrl = data.photos[0]?.src?.large || null;
                    if (imageUrl) imageCache.set(cacheKey, imageUrl);
                    return imageUrl;
                } catch (error) {
                    console.error("Pexels API error:", error);
                    return null;
                }
            }

            async function getCategoryImage(category) {
                const tmdbImage = await fetchTmdbImage(category, category);
                if (tmdbImage) return tmdbImage;

                const pexelsImage = await fetchPexelsImage(category, category);
                if (pexelsImage) return pexelsImage;

                return categoryImageMap[category] || null;
            }


            // --- Core Functions ---
            function showScreen(screen) {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                screen.classList.remove('hidden');
            }

            function populateCategories() {
                categoryList.innerHTML = '';
                for (const groupTitle in groupedCategories) {
                    const groupContainer = document.createElement('div');
                    
                    const titleElement = document.createElement('h3');
                    titleElement.className = 'category-group-title text-3xl font-bold text-left mb-2';
                    titleElement.textContent = groupTitle;
                    groupContainer.appendChild(titleElement);
                    
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-2 gap-4';
                    
                    groupedCategories[groupTitle].forEach(category => {
                        const button = document.createElement('button');
                        button.className = 'category-btn relative font-semibold rounded-lg shadow-md btn text-lg h-32 overflow-hidden group';
                        button.onclick = () => toggleCategorySelection(category, button);
                        
                        const img = document.createElement('img');
                        img.className = 'absolute inset-0 w-full h-full object-cover transition-transform duration-300 transform group-hover:scale-110';
                        const fallbackUrl = `https://placehold.co/400x400/667eea/ffffff?text=${encodeURIComponent(category.split(' ').map(w => w[0]).join(''))}`;
                        img.onerror = () => { img.src = fallbackUrl; };
                        img.src = categoryImageMap[category] || fallbackUrl;
                        
                        getCategoryImage(category).then(imageUrl => {
                            if(imageUrl) img.src = imageUrl;
                        });
                        
                        const overlay = document.createElement('div');
                        overlay.className = 'absolute inset-0 bg-black/50 flex items-center justify-center p-2';
                        
                        const text = document.createElement('span');
                        text.className = 'category-btn-text text-white text-2xl text-center';
                        text.textContent = category;
                        
                        overlay.appendChild(text);
                        button.appendChild(img);
                        button.appendChild(overlay);
                        
                        if (selectedCategories.includes(category)) button.classList.add('selected');
                        grid.appendChild(button);
                    });
                    groupContainer.appendChild(grid);
                    categoryList.appendChild(groupContainer);
                }
            }

            function toggleCategorySelection(category, buttonElement) {
                const index = selectedCategories.indexOf(category);
                if (index > -1) {
                    selectedCategories.splice(index, 1);
                    buttonElement.classList.remove('selected');
                } else {
                    selectedCategories.push(category);
                    buttonElement.classList.add('selected');
                }
                startSelectedBtn.disabled = selectedCategories.length === 0;
                startSelectedBtn.classList.toggle('opacity-50', selectedCategories.length === 0);
                startSelectedBtn.classList.toggle('cursor-not-allowed', selectedCategories.length === 0);
            }

            async function startMultiCategoryGame() {
                if (selectedCategories.length === 0) return;
                loadingIndicator.classList.remove('hidden');
                let combinedWords = [];
                let failedCategories = [];

                for (const category of selectedCategories) {
                    loadingStatus.textContent = `Loading ${category}...`;
                    const wordList = await fetchWordsForCategory(category);
                    if (wordList) combinedWords.push(...wordList);
                    else failedCategories.push(category);
                }

                loadingIndicator.classList.add('hidden');

                if (failedCategories.length > 0) alert(`Could not load: ${failedCategories.join(', ')}. Starting with the rest!`);
                if (combinedWords.length > 0) {
                    words = shuffleArray(combinedWords);
                    startGame();
                } else {
                    alert("Failed to load words. Please check your connection and try again.");
                }
            }
            
            async function fetchWordsForCategory(category) {
                const prompt = `Generate a JSON array of 25 unique items for a party guessing game like 'Heads Up'. Category: "${category}". The items must be well-known.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "STRING" } } } };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const wordList = JSON.parse(result.candidates[0].content.parts[0].text);
                        return wordList.map(word => ({ word, category }));
                    }
                    return null;
                } catch (error) {
                    console.error(`Failed to fetch category "${category}":`, error);
                    return null;
                }
            }

            async function startGame() {
                if (recordPerformance) {
                    await startRecording();
                }
                score = 0;
                timeLeft = 60;
                currentWordIndex = 0;
                showScreen(gameScreen);
                updateWord();
                timer = setInterval(updateTimer, 1000);
            }

            function updateTimer() {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                if (timeLeft <= 10 && timeLeft > 0) {
                    if (soundsReady) tickSound.triggerAttackRelease("C2", "8n", Tone.now());
                }
                if (timeLeft <= 0) {
                    endGame();
                }
            }

            function fitTextOnCard(element, text) {
                element.style.fontSize = '4rem';
                while (element.scrollWidth > element.clientWidth && parseFloat(element.style.fontSize) > 1) {
                    const currentSize = parseFloat(element.style.fontSize);
                    element.style.fontSize = `${currentSize - 0.2}rem`;
                }
            }

            async function updateWord() {
                if (currentWordIndex >= words.length) {
                    shuffleArray(words);
                    currentWordIndex = 0;
                }
                currentCardData = words[currentWordIndex];
                cardWord.textContent = currentCardData.word;
                cardCategory.textContent = currentCardData.category;
                
                fitTextOnCard(cardWord, currentCardData.word);
                cardFace.style.backgroundImage = 'none';
                
                currentWordIndex++;
            }
            
            function triggerConfetti() {
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                    confettiContainer.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }
            }

            function handleAnswer(isCorrect) {
                if (isCorrect) {
                    score++;
                    if (soundsReady) correctSound.triggerAttackRelease("G4", "8n", Tone.now());
                    triggerConfetti();
                } else {
                    if (soundsReady) passSound.triggerAttackRelease("C3", "8n", Tone.now());
                }
                card.classList.add('flipped');
                setTimeout(() => {
                    updateWord();
                    card.classList.remove('flipped');
                }, 400);
            }

            async function endGame() {
                if (timer) clearInterval(timer);
                timer = null;
                if (soundsReady) endSound.triggerAttackRelease("C3", "0.5s", Tone.now());
                
                if (recordPerformance) {
                    const recordingSaved = await stopRecording();
                    if (recordingSaved) {
                        showScreen(reviewModal);
                    } else {
                        animateScore(score);
                        showScreen(resultsScreen);
                    }
                } else {
                    animateScore(score);
                    showScreen(resultsScreen);
                }
            }
            
            function animateScore(finalScore) {
                scoreDisplay.textContent = 0;
                if (finalScore === 0) return;
                let currentScore = 0;
                const duration = 1500;
                const stepTime = Math.max(1, Math.floor(duration / finalScore));
                const scoreTimer = setInterval(() => {
                    currentScore++;
                    scoreDisplay.textContent = currentScore;
                    if (currentScore >= finalScore) clearInterval(scoreTimer);
                }, stepTime);
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            async function initAudio() {
                if (soundsReady || typeof Tone === 'undefined') return;
                try {
                    await Tone.start();
                    correctSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.5 } }).toDestination();
                    passSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
                    tickSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
                    endSound = new Tone.AMSynth({ harmonicity: 1.5, envelope: { attack: 0.01, decay: 0.5, sustain: 0.1, release: 0.5 } }).toDestination();
                    soundsReady = true;
                } catch (e) {
                    console.error("Audio context could not be started.", e);
                }
            }

            // --- Video Recording & Compositing ---
            function drawCanvasOverlay() {
                if (!recordPerformance) return;
                const ctx = recordingCanvas.getContext('2d');
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(cameraView, -recordingCanvas.width, 0, recordingCanvas.width, recordingCanvas.height);
                ctx.restore();

                const padding = 20;
                const cardWidth = recordingCanvas.width * 0.4;
                const cardHeight = 120;
                const x = recordingCanvas.width - cardWidth - padding;
                const y = recordingCanvas.height - cardHeight - padding;

                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.strokeStyle = '#4f46e5';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.roundRect(x, y, cardWidth, cardHeight, [15]);
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = '#4f46e5';
                ctx.font = 'bold 24px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(currentCardData.category, x + cardWidth / 2, y + 30);
                
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 36px "Paytone One"';
                ctx.fillText(currentCardData.word, x + cardWidth / 2, y + 75);

                animationFrameId = requestAnimationFrame(drawCanvasOverlay);
            }

            async function startRecording() {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720, facingMode: 'user' }, 
                        audio: true 
                    });
                    cameraView.srcObject = cameraStream;
                    await cameraView.play();
                    cameraContainer.classList.remove('hidden');

                    recordingCanvas.width = cameraView.videoWidth;
                    recordingCanvas.height = cameraView.videoHeight;

                    animationFrameId = requestAnimationFrame(drawCanvasOverlay);

                    const canvasStream = recordingCanvas.captureStream(30);
                    const audioTrack = cameraStream.getAudioTracks()[0];
                    canvasStream.addTrack(audioTrack);

                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm' });
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) recordedChunks.push(event.data);
                    };
                    mediaRecorder.start();
                } catch (err) {
                    console.error("Error starting recording:", err);
                    alert("Could not start recording. Please ensure camera/mic permissions are granted.");
                    recordToggle.querySelector('span').style.transform = 'translateX(0.25rem)';
                    recordPerformance = false;
                }
            }

            function stopRecording() {
                 return new Promise(resolve => {
                    if (!mediaRecorder || mediaRecorder.state !== 'recording') {
                        resolve(false);
                        return;
                    }
                    mediaRecorder.onstop = () => {
                        cancelAnimationFrame(animationFrameId);
                        animationFrameId = null;
                        const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        recordedBlobUrl = URL.createObjectURL(blob);
                        reviewVideo.src = recordedBlobUrl;
                        cameraStream.getTracks().forEach(track => track.stop());
                        cameraContainer.classList.add('hidden');
                        resolve(true);
                    };
                    mediaRecorder.stop();
                });
            }

            // --- Event Listeners Setup ---
            startGameBtn.addEventListener('click', async () => {
                await initAudio();
                selectedCategories = [];
                populateCategories();
                showScreen(categoryScreen);
            });

            themeToggle.addEventListener('click', () => {
                body.classList.toggle('theme-light');
                body.classList.toggle('theme-dark');
                const isLight = body.classList.contains('theme-light');
                themeToggle.querySelector('span').style.transform = isLight ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
            });

            recordToggle.addEventListener('click', () => {
                recordPerformance = !recordPerformance;
                recordToggle.querySelector('span').style.transform = recordPerformance ? 'translateX(1.25rem)' : 'translateX(0.25rem)';
            });

            discardBtn.addEventListener('click', () => {
                URL.revokeObjectURL(recordedBlobUrl);
                recordedBlobUrl = null;
                animateScore(score);
                showScreen(resultsScreen);
            });

            keepBtn.addEventListener('click', () => {
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = recordedBlobUrl;
                a.download = `AI-Charades-Performance-${new Date().getTime()}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(recordedBlobUrl);
                recordedBlobUrl = null;
                animateScore(score);
                showScreen(resultsScreen);
            });

            startSelectedBtn.addEventListener('click', startMultiCategoryGame);
            backToStartBtn.addEventListener('click', () => showScreen(startScreen));
            correctBtn.addEventListener('click', () => handleAnswer(true));
            passBtn.addEventListener('click', () => handleAnswer(false));
            playAgainBtn.addEventListener('click', startMultiCategoryGame);
            changeCategoryBtn.addEventListener('click', () => showScreen(categoryScreen));
            endRoundBtn.addEventListener('click', endGame);
            howToPlayBtn.addEventListener('click', () => howToPlayModal.classList.remove('hidden'));
            rulesBtn.addEventListener('click', () => rulesModal.classList.remove('hidden'));
            closeHowToPlayBtn.addEventListener('click', () => howToPlayModal.classList.add('hidden'));
            closeRulesBtn.addEventListener('click', () => rulesModal.classList.add('hidden'));

            // --- Initial App Setup ---
            showScreen(startScreen);
        });
    </script>
</body>
</html>
